<!doctypehtml><meta charset=utf-8><meta content=width=device-width,initial-scale=1 name=viewport><title>Filipe Laíns - GSoC 2020 - Wireshark USB HID Report Descriptor Parser</title><meta content="2020-08-23 17:59:11+01:00"property=article:published_time><meta content=2024-07-22T00:56:44.457718 property=article:modified_time><link href=../../static/css/style.css rel=stylesheet><link href=../../static/css/pygments.css rel=stylesheet><body><section class=section><div class=container><nav aria-label="main navigation"class="navbar is-transparent pb-3"role=navigation><div class=navbar-brand><a class=navbar-item href=https://ffy00.github.io> <h1 class=title>Filipe Laíns</h1> </a><a aria-expanded=false aria-label=menu class=navbar-burger data-target=main-navbar role=button> <span aria-hidden=true></span> <span aria-hidden=true></span> <span aria-hidden=true></span> </a></div><div class=navbar-menu id=main-navbar><div class=navbar-end><a class=navbar-item href=../..>Home</a><a class=navbar-item href=../../blog>Blog</a></div></div></nav><h1 class="title has-text-centered">GSoC 2020 - Wireshark USB HID Report Descriptor Parser</h1><h1 class="subtitle has-text-centered">17:59 23/08/2020</h1><div class=content><section class=content id=introduction><h1 class=title>Introduction</h1><p>Today I am writing about my project for <a href=https://summerofcode.withgoogle.com>Google Summer of Code</a> 2020, improving the Wireshark USB HID dissector. This summer, with the help of <a href=https://github.com/desowin>Tomasz Moń</a>, I am taking upon the task of writing a HID report descriptor parser and adding annotations for HID data in <a href=https://www.wireshark.org>Wireshark</a>.<p>Moving forward with this project, I have some personal goals. I would really like to have Wireshark dissect the HID vendor pages – vendor data. That will make it easier for people without much HID knowledge to reverse engineer vendor protocols and contribute to projects such as <a href=https://github.com/libratbag/libratbag>libratbag</a>. My other goal was designing the report descriptor parser in such a way it would be easy to add new dissections for HID data.</section><section class=content id=preparation><h1 class=title>Preparation</h1><p>Before starting working on the HID report descriptor parser, I did a bit of refactoring to the HID dissector and changed the HID report descriptor annotations to have the data look as shown in the <a href=https://www.usb.org/hid>specification</a>. I also added some missing HID usage pages.<p>This allowed me to get to know a bit more about the Wireshark internals, as well as how the HID dissector was implemented. I think this step was incredibly helpful.</section><section class=content id=the-work><h1 class=title>The work</h1><p>Before I started working on the HID report descriptor parser, I spent a few days with the HID specification. This allowed me to familiarize myself more with the intricacies of the of HID and the report descriptor format. It helped a lot designing the data structures and the parser. Even with this preparation, I did not get it right at first, but I got it close enough that it was easy to fix.<p>After having the parser implemented, I started working on the data annotations. Along the way, I naturally tweaked the parser to better adapt to our use case. The step of writing the annotations also presented its issues. Wireshark operates data at a byte level, but HID operates at a bit level. There were already some internal ways to try to get around this issue, but they needed to be expanded to properly cater to the needs of HID. Wireshark has encontered some protocols needed to dynamically annotate data on a bit level, but their requirements were simpler, they mostly wanted to annotate a fixed data type. HID, however, can have long data fields, so our main question here was how to annotate byte arrays that are bit limited? The same approach used in other types of data couldn't be applied here.<p>Overcoming these issues, I think we got some nice end results.<figure><img alt src=../../static/img/posts/01/mouse-dissection.png><figcaption>Image 1 - Mouse data dissection</figcaption></figure><figure><img alt src=../../static/img/posts/01/keyboard-dissection.png><figcaption>Image 2 - Keyboard data dissection</figcaption></figure><figure><img alt src=../../static/img/posts/01/joystick-dissection.png><figcaption>Image 3 - Joystick data dissection</figcaption></figure><figure><img alt src=../../static/img/posts/01/vendor-dissection.png><figcaption>Image 4 - Vendor data dissection</figcaption></figure><p>As you can see, annotations for some fields are still missing. I will keep adding more fields as time allows. What is important here is that I accomplished my goal related to the report descriptor parser design, adding support for more fields is easy and I hope this will enable other people to contribute.<p>During this, I found an issue where the USB bus ID and device address might not initialized, it was <a href=https://code.wireshark.org/review/#/c/37328>fixed by Tomasz</a>.</section><section class=content id=gotchas><h1 class=title>Gotchas</h1><section class=content id=missing-descriptors><h2>Missing descriptors</h2><p>To dissect the HID data we need access to the report descriptor, which tells us how the reports are structured. This is also the case of for eg. the USB configuration descriptors, we need to look at the configuration descriptors to understand the endpoints. But there is an issue, we are dissecting from a capture, either live or from a file, we may not have access to the device to fetch this descriptors. Because of this, we need the packets that ask the device for this information to be included in the capture. Fortunately, if you have a recent enough <a href=https://github.com/the-tcpdump-group/libpcap>libpcap</a> version, it asks the device for the USB configuration descriptors when you start recording, but unfortunately, it doesn't do the same for the HID report descriptors.<p>So, if you want to look at HID data dissections, you need to start recording before plugging in the device, this way you will also capture the packets where the operating system asks the device for the HID descriptors.</section><section class=content id=usb-dissector-bug><h2>USB dissector bug</h2><p>While working on this project, I found some cases where the data wasn't being properly dissected by the HID dissector. Tomasz had a look at them and it turns out there is a bug in the USB dissector that causes this data to be dissected twice. The bug hasn't been fixed yet, so if your data isn't being dissected, even though you have the HID report descriptor available, this is probably the cause.</section><section class=content id=multiple-usage-pages-per-item><h2>Multiple usage pages per item</h2><p>This is allowed by the HID specification but is not common in the wild. I opted to work on more relevant things.</section></section><section class=content id=conclusion><h1 class=title>Conclusion</h1><p>Overall, I think the project went fine, but not perfectly. There were some issues along the way, but in the end I did achieve the goals that were set. I think both me and Tomasz were hoping for me to be able to do a bit more than this, maybe add dissections for a custom/vendor protocol on top of this new annotations, but unfortunately that wasn't possible.<p>I would like to give a huge thanks to Tomasz, he helped me out figuring the Wireshark internals and got me out of some rabbit holes when trying to interpret the HID specification. I would also like to thanks Benjamin Tissoires, who really helped me get started with the HID protocol and build up the base knowledge essential to me being able to complete this project. Finally, I want to thank the rest of the Wireshark developers who helped me out in the IRC and reviewed my patches, as well as <a href=https://www.google.com>Google</a> for making this experience possible.</section><section class=content id=code><h1 class=title>Code</h1><p>Here are the more significant patches.<ul><li>General dissector refactoring: <a href=https://github.com/wireshark/wireshark/commit/1e60efeb641c83a9436b0a5e258af56ee4ef413d>1e60efeb641c83a9436b0a5e258af56ee4ef413d</a><li>HID report parser annotations refactoring: <a href=https://github.com/wireshark/wireshark/commit/f8de1fcddb1ef452a3f5429bff69cd1976d20e07>f8de1fcddb1ef452a3f5429bff69cd1976d20e07</a><li>Save the HID report descriptors: <a href=https://github.com/wireshark/wireshark/commit/c3e2f3cf9c556cc849b50cdba7b2a9af05effe54>c3e2f3cf9c556cc849b50cdba7b2a9af05effe54</a><li>Annotate HID data: <a href=https://github.com/wireshark/wireshark/commit/f1bc8ad34b55cba7234536483d42c551fc3b2f17>f1bc8ad34b55cba7234536483d42c551fc3b2f17</a><li>Add HID report descriptor parser: <a href=https://github.com/wireshark/wireshark/commit/2d49ab3d25435be3d15c9a59189f4017db5c5ddb>2d49ab3d25435be3d15c9a59189f4017db5c5ddb</a><li>Save input and output usages separately: <a href=https://github.com/wireshark/wireshark/commit/bef04c21b4664f4318705ec3ccb48919407f0484>bef04c21b4664f4318705ec3ccb48919407f0484</a><li>Dissect vendor data: <a href=https://github.com/FFY00/wireshark/commit/b9588c213c6b70cc1e0045917c3f0aeb02c10408>b9588c213c6b70cc1e0045917c3f0aeb02c10408</a><li>Minimal dissection of unknown (unimplemented) usages: <a href=https://github.com/FFY00/wireshark/commit/a5ed52b66680b12af1bb50f015972d3554619240>a5ed52b66680b12af1bb50f015972d3554619240</a><li>Dissect axis and vectors from th generic desktop usages page: <a href=https://github.com/FFY00/wireshark/commit/2429dae6797f8e533558d06ff36c4a789ddf1c4f>2429dae6797f8e533558d06ff36c4a789ddf1c4f</a><li>Dissect the button usage page: <a href=https://github.com/FFY00/wireshark/commit/8a389fef8f8ee50ecddfe3b6cba3345fe20dca52>8a389fef8f8ee50ecddfe3b6cba3345fe20dca52</a><li>Dissect padding: <a href=https://github.com/FFY00/wireshark/commit/73a3afcacefee0ada95fb1dee5fe7c42fafb975b>73a3afcacefee0ada95fb1dee5fe7c42fafb975b</a><li>Dissect keyboard usage page: <a href=https://github.com/FFY00/wireshark/commit/101275395f97aaa1d9a3bd225fdf85c39baa4716>101275395f97aaa1d9a3bd225fdf85c39baa4716</a></ul><p>Some of the patches haven't been merged yet, they are waiting on other patches that touch the Wireshark internals and are still under review. You can check my worktree <a href=https://github.com/FFY00/wireshark/commits/hid>here</a> (<a href=https://github.com/FFY00/wireshark/commits/101275395f97aaa1d9a3bd225fdf85c39baa4716>link</a> with a pinned commit).</section></div></div></section></body><script src=../../static/js/bulma-navbar.js></script>